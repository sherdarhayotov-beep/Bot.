from telegram import (
    Update, InlineKeyboardButton, InlineKeyboardMarkup
)
from telegram.ext import (
    Updater, CommandHandler, CallbackQueryHandler,
    MessageHandler, Filters, CallbackContext
)
import sqlite3

# ====== SENING MA‚ÄôLUMOTLARING ======
TOKEN = "7974172226:AAFOIPcl7LJmxJcV5rG9AnclbPqQlBvZNLo"  # @BotFather token
ADMIN_ID = 7368861068  # Telegram ID
CHANNELS = ["@KINOLaboruz"]  # Majburiy obuna kanali
# ====================================

# ---------------- DATABASE ----------------
conn = sqlite3.connect("movies.db", check_same_thread=False)
cur = conn.cursor()
cur.execute("""
CREATE TABLE IF NOT EXISTS movies (
    code TEXT PRIMARY KEY,
    file_id TEXT
)
""")
conn.commit()

# ---------------- SUB CHECK ----------------
def is_subscribed(bot, user_id):
    for channel in CHANNELS:
        try:
            member = bot.get_chat_member(channel, user_id)
            if member.status not in ["member", "administrator", "creator"]:
                return False
        except:
            return False
    return True

# ---------------- START ----------------
def start(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    if is_subscribed(context.bot, user_id):
        update.message.reply_text("üé¨ Kino kodini yuboring:")
    else:
        buttons = []
        for ch in CHANNELS:
            buttons.append([InlineKeyboardButton(
                f"üì¢ {ch}", url=f"https://t.me/{ch.replace('@','')}"
            )])
        buttons.append([InlineKeyboardButton(
            "‚úÖ Obunani tekshirish", callback_data="check_sub"
        )])
        update.message.reply_text(
            "‚ùó Davom etish uchun kanalga obuna bo‚Äòling:",
            reply_markup=InlineKeyboardMarkup(buttons)
        )

def check_sub(update: Update, context: CallbackContext):
    q = update.callback_query
    q.answer()
    if is_subscribed(context.bot, q.from_user.id):
        q.edit_message_text("‚úÖ Obuna tasdiqlandi!\n\nüé¨ Kino kodini yuboring:")
    else:
        q.answer("‚ùå Hali obuna bo‚Äòlmagansiz!", show_alert=True)

# ---------------- USER CODE CHECK ----------------
def check_code(update: Update, context: CallbackContext):
    user_id = update.effective_user.id
    if not is_subscribed(context.bot, user_id):
        update.message.reply_text("‚ùó Avval kanallarga obuna bo‚Äòling.")
        return

    code = update.message.text.strip()
    cur.execute("SELECT file_id FROM movies WHERE code=?", (code,))
    row = cur.fetchone()

    if row:
        update.message.reply_video(row[0])
    else:
        update.message.reply_text("‚ùå Bunday kodli kino topilmadi.")

# ---------------- ADMIN PANEL ----------------
def admin(update: Update, context: CallbackContext):
    if update.effective_user.id != ADMIN_ID:
        return

    buttons = [
        [InlineKeyboardButton("‚ûï Kino qo‚Äòshish", callback_data="add_movie")]